<!DOCTYPE html>
    <head>
        <title>Deep Learning</title>
        <link rel="stylesheet" media="screen" href ="static/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>   
        <link href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.10/c3.min.css" rel="stylesheet"/>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.10/c3.min.js"></script>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
       
    </head>
    
    <body>
        <style>
            /* label 和 select 之間的間隔 */
            form label {
                width: 20%;
            }
            .flex-container {
                    display: flex;
                }
    
            .flex-container > div {          
                color: black;          
            }
            a.list-group-item{
                font-size: 24px;
            }
            input {
                float:left;
            }
            .badge {
                margin:3px;    
            }
        </style>
        {% include '_navbar.html' %}
        <main role="main" class="col-md-9 ml-sm-auto col-lg-10 px-1">
            {% if error %}
            <div class="alert alert-danger">
            <strong>Error:</strong> {{ error }}
            </div>
            {% endif %}
            <div class="flex-container">
                <!-- <div class="k-content k-grid__item k-grid__item--fluid k-grid k-grid--hor" id="k_content"> -->
                    <div class="k-portlet k-portlet--tabs">
                        <div class="k-portlet__head k-portlet__head--lg k-portlet__head--noborder k-portlet__head--break-sm">
                            <div class="k-portlet__head-label">
                                <h3 class="k-portlet__head-title">Records</h3>
                            </div>
                            <div class="k-portlet__head-toolbar">
                                <div class="k-portlet__head-wrapper k-form">
                                    <div class="k-form__group k-form__group--inline k-margin-r-10">
                                        <!-- <div class="k-form__label">
                                            Sort By:
                                        </div>
                                        <select class="form-control bootstrap-select" id="k_form_status" title="Status">
                                            <option class="bs-title-option" value="">Status</option>
                                            <option value="1">TaskName</option>
                                            <option value="2">Time</option>
                                            <option value="3">MaxNatch</option>
                                            <option value="4">Success</option>
                                            <option value="5">Error</option>
                                            <option value="6">Abort</option>
                                        </select> -->
                                    </div>
                                    <!-- <input type="button" class="btn btn-brand btn-upper btn-bold" onclick="test_port()"value="Test">                                       -->
                                    <div class="k-form__group k-form__group--inline k-margin-r-10"></div>      <!-- 間隔 -->
                                    <!-- <form action="{{ url_for('view_training') }}" method="post">
                                        <input type="submit" class="btn btn-danger btn btn-brand btn-upper btn-bold" id="delBtn" value="Delete" name="delBtn">
                                    </form> -->
                                    <!-- <input type="submit" class="btn btn-danger btn btn-brand btn-upper btn-bold" id="delBtn" value="Delete" name="delBtn" onclick="del_port()"> -->
                                    <input type="button" style="display:none" class="btn btn-danger btn btn-brand btn-upper btn-bold" id="delBtn" value="Del" name="delBtn" onclick="del_port()">
                                    <div class="k-form__group k-form__group--inline k-margin-r-10"></div>
                                    <input type="button" style="display:none" class="btn btn-success btn btn-brand btn-upper btn-bold" id="cancelBtn" value="Cancel" name="cancelBtn" onclick="cancel()">
                                    <input type="button" class="btn btn-success btn btn-brand btn-upper btn-bold" id="edit" value="Edit" name="btn" onclick="create_delBtn()">
                                </div>
                            </div>
                        </div>

                        <div class="k-portlet__body">
                            <!--begin::Portlet-->                                    
                            <div class="k-datatable k-datatable--default k-datatable--brand k-datatable--loaded k-datatable--scroll" id="k_recent_orders">
                                <table id="aaaaaa" class="k-datatable__table" style="display: block; min-height: 100px; max-height: 430px; ">
                                    <thead class="k-datatable__head">
                                        <tr class="k-datatable__row" style="left: 5px;">
                                            <th style="visibility:hidden; width: 20px" class="k-datatable__cell--center k-datatable__cell k-datatable__cell--check">
                                                <span>
                                                    <label class="k-checkbox k-checkbox--single k-checkbox--solid k-checkbox--brand">
                                                        <input id="all" type="checkbox" onclick="select_all()">&nbsp;
                                                    <span></span>
                                                    </label>
                                                </span>
                                            </th>
                                            <th style="width: 360px;" data-field="name" class="k-datatable__cell">
                                                <span >Task Name</span>
                                            </th>
                                            <th style="width: 140px;" data-field="time" class="k-datatable__cell">
                                                <span >Time</span>
                                            </th>
                                            <th style="width: 145px;" data-field="maxbatch" class="k-datatable__cell">
                                                <span >MaxBatch</span>
                                            </th>
                                            <th style="width: 95px;"data-field="batchsize" class="k-datatable__cell">
                                                <span >BatchSize</span>
                                            </th>
                                            <th style="width: 120px;" data-field="sub" data-autohide-disabled="false" class="k-datatable__cell">
                                                <span >Subdivisions</span>
                                            </th>
                                            <th style="width: 190px;" data-field="lr" data-autohide-disabled="false" class="k-datatable__cell">
                                                <span >LearningRate</span>
                                            </th>
                                            <th data-field="Actions" data-autohide-disabled="false" class="k-datatable__cell">
                                                <span >Action</span>
                                            </th>                       
                                        </tr>
                                    </thead>
                                    
                                    <tbody style="max-height: 375.5px;" class="k-datatable__body ps ps--active-y">
                                        
                                        {%- for item in tree recursive %}                                       
                                        <tr class="k-datatable__row" style="left: 0px;">
                                            <td style="visibility:hidden; width: 20px;" class="k-datatable__cell--center k-datatable__cell k-datatable__cell--check">
                                               
                                                    <label class="k-checkbox k-checkbox--single k-checkbox--solid k-checkbox--brand">
                                                        <input id="{{ item.Id }}" type="checkbox" value="{{ item.RunTime }}">&nbsp;
                                                <span></span>
                                                </label>                                               
                                            </td>
                                            
                                            <td style="width: 360px;" class="k-datatable__cell k-datatable__cell--sort" onclick="select_click({{ item.Id }})">                                               
                                                <span  class="k-label-font-color-3 k-font-bold">{{ item.TaskName }}</span>                                              
                                            </td>
                                            <td style="width: 185px;" class="k-datatable__cell k-datatable__cell--sort" onclick="select_click({{ item.Id }})">                                                 
                                                    <span  class="k-label-font-color-3 k-font-bold">{{ item.RunTime }}</span>                                                    
                                                </td>
                                            <td style="width: 160px;" class="k-datatable__cell k-datatable__cell--sort" onclick="select_click({{ item.Id }})">                                              
                                                <span class="k-label-font-color-3 k-font-bold">{{ item.MaxBatch }}</span>                                              
                                            </td>
                                            <td style="width: 100px;" class="k-datatable__cell k-datatable__cell--sort" onclick="select_click({{ item.Id }})">
                                                <span >{{ item.BatchSize }}</span>
                                            </td>
                                            <td style="width: 140px;" class="k-datatable__cell k-datatable__cell--sort" onclick="select_click({{ item.Id }})">                                                                                             
                                                <span class="k-label-font-color-3 k-font-bold">{{ item.Subdivisions }}</span>                                              
                                            </td>
                                            <td style="width: 200px;" class="k-datatable__cell k-datatable__cell--sort" onclick="select_click({{ item.Id }})">                                                
                                                <span class="k-label-font-color-3 k-font-bold">{{ item.LearningRate }}</span>                                               
                                            </td>
                                            <td class="k-datatable__cell k-datatable__cell--sort" onclick="select_click({{ item.Id }})">
                                                <span style="width: 100px;">
                                                    {% if item.Status == "Abort" %}
                                                    <span id="span_c{{item.Id}}" class="k-badge k-badge--focus k-badge--dot k-badge--md"></span>
                                                    {% elif item.Status == "Error" %}
                                                    <span id="span_c{{item.Id}}" class="k-badge k-badge--danger k-badge--dot k-badge--md"></span>
                                                    {% elif item.Status == "Success" %}
                                                    <span id="span_c{{item.Id}}" class="k-badge k-badge--success k-badge--dot k-badge--md"></span>
                                                    {% else %}
                                                    <span id="span_c{{item.Id}}" class="k-badge k-badge--brand k-badge--dot k-badge--md"></span>
                                                    {%- endif %}
                                                    <span id="span{{item.Id}}" class="k-label-font-color-3 k-font-bold">{{ item.Status }}</span>
                                                </span>
                                            </td>
                                            <td class="k-datatable__cell k-datatable__cell--sort" onclick="select_click({{ item.Id }})">
                                                <span style="width: 180px;">
                                                    <div style="display: inline">
                                                        {% if item.Status == "Training" %}
                                                        <input type="button" class ="la la-edit" value="Close" id="close_btn" onclick="close_task({{ item.PID }})">
                                                        {%- endif %}
                                                        <input type="button" class ="la la-edit" value="test" onclick="test_port({{ item.Id }})">
                                                    </div>
                                                </span>
                                            </td>
                                        </tr>
                                        {%- endfor %}
                                        <!-- <div class="ps__rail-x" style="left: 0px; bottom: 0px;">
                                            <div class="ps__thumb-x" tabindex="0" style="left: 0px; width: 0px;"></div>
                                        </div>
                                        <div class="ps__rail-y" style="top: 60px; height: 376px; right: 0px;">
                                            <div class="ps__thumb-y" tabindex="0" style="top: 44px; height: 281px;"></div>
                                        </div> -->
                                    </tbody>
                                </table>
                                  <div class="k-datatable__pager k-datatable--paging-loaded clearfix">
                                    <ul class="k-datatable__pager-nav">
                                        <li>
                                            <a title="First" class="k-datatable__pager-link k-datatable__pager-link--first k-datatable__pager-link--disabled" data-page="1" disabled="disabled">
                                                <i class="la la-angle-double-left"></i>
                                            </a>
                                        </li>
                                        <li>
                                            <a title="Previous" class="k-datatable__pager-link k-datatable__pager-link--prev k-datatable__pager-link--disabled" data-page="1" disabled="disabled">
                                                <i class="la la-angle-left"></i>
                                            </a>
                                        </li>
                                        <li style="display: none;">
                                            <a title="More pages" class="k-datatable__pager-link k-datatable__pager-link--more-prev" data-page="1">
                                                <i class="la la-ellipsis-h"></i>
                                            </a>
                                        </li>
                                        <li style="display: none;"><input type="text" class="k-pager-input form-control" title="Page number"></li>
                                        <li>
                                            <a class="k-datatable__pager-link k-datatable__pager-link-number k-datatable__pager-link--active" data-page="1" title="1">1</a>
                                        </li>
                                        <li>
                                            <a class="k-datatable__pager-link k-datatable__pager-link-number" data-page="2" title="2">2</a>
                                        </li>
                                        <li>
                                            <a title="Last" class="k-datatable__pager-link k-datatable__pager-link--last" data-page="100">
                                                <i class="la la-angle-double-right"></i>
                                            </a>
                                        </li>
                                    </ul>
                                 
                                </div>
                            </div>                              
                        </div>
                    </div>
                </div>
            </div>
            <div class="k-content__body k-grid__item k-grid__item--fluid" id="k_content_body">
                    <h3 class="k-portlet__head-title" id="modelName" style="margin: 10px;">No choose model</h3>
                    <!-- <div class="alert alert-light alert-elevate" role="alert"> -->
                        <div id="mychart"></div>
            </div>
        </main>
        <style>
            h2{
                margin: 5px;
            }
            td span{
                text-align: left;
            }
        </style>
        <script>
            function test_port(id){
                dirname=document.getElementById(id).value
                var data = {
                    'dirname': dirname
                }
                $.ajax({
                    type:'POST',
                    url:'{{url_for("view_training_test_post")}}',
                    data:data,
                    dataType:'json',
                    success:function(data){
                        window.location.href = "test";
                    }
                });
            }

            function cancel(){
                window.location.href = "view_training";
            }
            
            function create_delBtn(){
                document.getElementById("delBtn").style.display = "block";
                document.getElementById("cancelBtn").style.display = "block";
                document.getElementById("edit").style.display = "none";
                $(".k-datatable__cell--check").css("visibility","visible");
                // $(".k-datatable__cell--check").checked = false;
                var len = {{tree|length}};            
                for(i =1; i < len+1; i++){
                    document.getElementById(i).checked = false;
                }
            }

            function close_task(pid){
                var data = {
                    'pid': pid 
                }
                $.ajax({
                    type:'POST',
                    url:'{{url_for("close_task")}}',
                    data:data,
                    dataType:'json',
                    success:function(data){
                        window.location.href = "view_training";
                    }
                });
            }
            
            function select_all(){
                var len = {{tree|length}};
                if (document.getElementById("all").checked) {
                    for(i =1; i < len+1; i++){
                        document.getElementById(i).checked = true;
                    }
                }else{
                    for(i =1; i < len+1; i++){
                        document.getElementById(i).checked = false;
                    }
                }
            }
            
            function select_click(id){
                // if ($(".k-datatable__cell--check").css("visibility") == "hidden"){
                post_function(document.getElementById(id).value);
            
                if (document.getElementById(id).checked) {
                    document.getElementById(id).checked = false;
                }else{
                    document.getElementById(id).checked = true;
                }
            }

            $( document ).ready(function() {
                post_function();              
                chart = c3.generate({
                    title: {
                        text:'External JSON loading via C3.js'
                    },
                    bindto: '#mychart',
                    data: {
                        json:{
                            'avg_loss': []
                        },
                        type: 'area-spline',
                    }
                });
                $('li a.active').removeClass('active');
                $('a[href="' + location.pathname + '"]').closest('li a').addClass('active');

                $('#aaaaaa').DataTable({
                        "scrollY":        "200px",
                        "scrollCollapse": true,
                        "paging":         false
                });
            });
            
            function post_function(dirname)
            {
                {% for item in tree%}
                    {% if item.Status == "Training" %}
                        $('#train_nav').show();
                    {%endif%}
                {%endfor%}

                var data = {
                    'dirname':dirname,
                }
                $.ajax({
                    type:'POST',
                    url:'{{url_for("train_model_post")}}',
                    data:data,
                    dataType:'json',
                    success:function(data){                     
                        $('#taskname span').text(data[0]["TaskName"]);
                        $('#maxbatch span').text(data[0]["MaxBatch"]);
                        $('#batchsize span').text(data[0]["BatchSize"]);
                        $('#sub span').text(data[0]["Subdivisions"]);
                        $('#lr span').text(data[0]["LearningRate"]);
                        $('#status span').text(data[0]["status"]);
                        $('#modelName').text(data[0]["RunTime"]);
                        if (data[0]["status"] != "Training"){    // 如果不是正在訓練
                            var file = 'static/task/'+dirname+'/AvgLoss.json';
                            //console.log(file)
                            $.getJSON(file, function (externaldata) {
                                //console.log(externaldata)
                                chart.load({ json: externaldata});
                                chart.flush();
                            });
                        }else{
                            var t2 = window.setInterval(()=>{                    
                                $.ajax({
                                    type:'POST',
                                    url:'{{url_for("training_status_post")}}',
                                    dataType:'json',
                                    success:function(data){
                                        console.log(data[0]["status"]);
                                        //console.log(data[0]["avg_loss"]);
                                        if (data[0]["status"] != "Training")
                                        {
                                            var name = 'span'+data[0]['ID'];
                                            var name_c = 'span_c'+data[0]['ID'];
                                            var span_text = document.getElementById(name);
                                            var span_class = document.getElementById(name_c);
                                            span_class.className = 'k-badge k-badge--success k-badge--dot k-badge--md';
                                            span_text.innerText = "Success";
                                            $('#close_btn').hide();
                                            $('#status span').html(data[0]["status"]);
                                            clearInterval(t2);
                                            $('#train_nav').hide();
                                        }
                                        chart.load({ json:{
                                            'avg_loss': data[0]['avg_loss']}}
                                        );
                                        chart.flush();
                                    },
                                });
                            }, 4000);
                        }
                    }
                });
            }

            function cal_checkbox_select(select_ID, select_name, select_PID){
                var len = {{tree|length}};
                {%- for item in tree %}
                    if ("{{ item.Id }}" != ""){                       
                        if (document.getElementById("{{ item.Id }}").checked){
                            select_ID.push("{{ item.Id }}");
                            select_name.push("{{ item.RunTime }}");
                            select_PID.push("{{ item.PID }}");
                        }
                    }
                {% endfor %}
            }
            
            function del_port()
            {
                select_ID = [];
                select_name = [];
                select_PID = [];
                cal_checkbox_select(select_ID, select_name, select_PID);
                var answer = confirm("Make sure you want to delete it !");
                console.log(answer)
                $.ajax({
                    type:'POST',
                    url:'{{url_for("view_training_del_post")}}',
                    data:JSON.stringify(select_name),
                    contentType: "application/json",
                    success:function(data){
                        window.location.href = "view_training";
                    }
                });
            }
        </script>
    </body>
   
</html>